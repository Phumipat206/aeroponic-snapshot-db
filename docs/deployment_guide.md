# Aeroponic Snapshot Database - Deployment Guide

This guide details how to deploy the Aeroponic Snapshot Database on a fresh Linux Virtual Machine (VM), suitable for production use in environments with unstable internet.

## Prerequisites

-   **Virtual Machine**: Ubuntu 24.04 LTS (Recommended) or Debian 12
-   **Specs**: 2 vCPU, 4GB RAM, 20GB Disk (Minimum)
-   **Network**: Bridged Adapter (so the VM gets an IP on the local network)

## 1. System Preparation

First, update the system packages to the latest version.

```bash
sudo apt update && sudo apt upgrade -y
```

Install essential system dependencies:

```bash
sudo apt install -y python3 python3-pip python3-venv python3-dev build-essential libopencv-dev ufw git curl nginx
```

## 2. Database Installation (SQLite)

The system uses **SQLite** by default, which is a serverless database engine. This is ideal for this project because:
-   It requires zero configuration.
-   It stores the entire database as a single file (`aeroponic_snapshots.db`).
-   It is robust against power failures (ACID compliant).

*No additional installation is required as `sqlite3` is included in Python.*

## 3. Application Setup

1.  **Clone/Copy the Project**:
    Copy your project files to `/opt/aeroponic` or your home directory.

    ```bash
    mkdir -p ~/aeroponic
    # (Copy files here via SCP or Git)
    cd ~/aeroponic
    ```

2.  **Create Virtual Environment**:

    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```

3.  **Install Python Dependencies**:

    ```bash
    pip install --upgrade pip
    pip install -r requirements.txt
    ```

4.  **Configuration**:
    Create a `.env` file from the example.

    ```bash
    cp .env.example .env
    nano .env
    ```

    **Key Settings to Change:**
    -   `SECRET_KEY`: Generate a random string.
    -   `API_KEYS`: Define keys for your cameras (e.g., `cam1-secret,cam2-secret`).
    -   `ADMIN_TOKEN`: Set a token for administrative actions.

## 4. Security Configuration

### A. Firewall (UFW)

Enable the firewall to allow only necessary traffic.

```bash
# Deny all incoming by default
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH (Port 22) - CRITICAL!
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8443/tcp  # If running Flask directly

# Enable Firewall
sudo ufw enable
```

### B. Application Security

1.  **Change Admin Password**:
    On first login, go to **Settings** and change the default `admin` password immediately.

2.  **API Security**:
    Ensure `API_KEYS` in `.env` are strong and kept secret. These keys are required for the Raspberry Pi to upload images.

## 5. Automation (Systemd Service)

Create a service to start the application automatically on boot.

1.  Create the service file:

    ```bash
    sudo nano /etc/systemd/system/aeroponic.service
    ```

2.  Add the following content (adjust paths/user as needed):

    ```ini
    [Unit]
    Description=Aeroponic Snapshot Database
    After=network.target

    [Service]
    User=ubuntu
    WorkingDirectory=/home/ubuntu/aeroponic
    Environment="PATH=/home/ubuntu/aeroponic/.venv/bin"
    ExecStart=/home/ubuntu/aeroponic/.venv/bin/python run.py
    Restart=always

    [Install]
    WantedBy=multi-user.target
    ```

3.  Enable and start the service:

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable aeroponic.service
    sudo systemctl start aeroponic.service
    ```

4.  Check status:

    ```bash
    sudo systemctl status aeroponic.service
    ```

## 6. Raspberry Pi Setup (Client)

To configure the Raspberry Pi to upload images automatically:

1.  **Copy the Upload Script**:
    Copy `docs/demo_upload.py` (or `raspberry_pi_scripts/upload_snapshot.py`) to the Pi.

2.  **Test Upload**:

    ```bash
    python3 upload_snapshot.py --url http://192.168.1.xxx:8443 --key YOUR_API_KEY test_image.jpg
    ```

3.  **Setup Auto-Upload (Crontab)**:
    Edit crontab:
    ```bash
    crontab -e
    ```

    Add line to upload every hour:
    ```cron
    0 * * * * /usr/bin/python3 /home/pi/upload_snapshot.py --capture --url http://192.168.1.xxx:8443 >> /home/pi/upload.log 2>&1
    ```

---
*Generated by Antigravity for Aeroponic Project*
