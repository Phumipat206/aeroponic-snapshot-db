{% extends "base.html" %}

{% block page_title %}Create Video{% endblock %}

{% block content %}
<div class="help-box">
    <h3><i class="fas fa-info-circle"></i> How to Create a Time-lapse Video</h3>
    <ul>
        <li>Give your video a <strong>name</strong> and select filters (project, camera, category, date range)</li>
        <li>Adjust the <strong>FPS</strong> slider to control playback speed (lower = slower, more detailed)</li>
        <li>Enable <strong>timestamp overlay</strong> to track dates in the video</li>
        <li>For best results, filter by a single <strong>camera</strong> to avoid mixed angles</li>
        <li>Do <strong>not close the page</strong> while the video is being generated</li>
    </ul>
</div>
<div class="card">
    <div class="card-header">
        <i class="fas fa-video"></i>
        <h2>Create Time-lapse Video</h2>
    </div>
    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Generate a growth video from your snapshots</p>
    
    <form method="POST" id="videoForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="video_name"><i class="fas fa-file-video"></i> Video Name</label>
                <input type="text" id="video_name" name="video_name" value="timelapse" required>
            </div>
            
            <div class="form-group">
                <label for="category_id"><i class="fas fa-folder"></i> Category</label>
                <select id="category_id" name="category_id">
                    <option value="">-- All Categories --</option>
                    {% for category in categories %}
                        {% if category.parent_id %}
                        <option value="{{ category.id }}">
                            └─ {{ category.name }}
                        </option>
                        {% else %}
                        <option value="" disabled style="font-weight:bold; color:var(--text-secondary);">
                            {{ category.name }}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Project & Camera Filters -->
        <div class="form-grid">
            <div class="form-group">
                <label for="project_name"><i class="fas fa-project-diagram"></i> Project</label>
                <select id="project_name" name="project_name" onchange="loadCameras()">
                    <option value="">-- All Projects --</option>
                    {% if filters and filters.projects %}
                        {% for project in filters.projects %}
                            <option value="{{ project }}">{{ project }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="camera_id"><i class="fas fa-camera"></i> Camera</label>
                <select id="camera_id" name="camera_id">
                    <option value="">-- All Cameras --</option>
                    {% if filters and filters.cameras %}
                        {% for camera in filters.cameras %}
                            <option value="{{ camera }}">{{ camera }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="start_time"><i class="fas fa-calendar"></i> From Date</label>
                <input type="datetime-local" id="start_time" name="start_time">
            </div>
            
            <div class="form-group">
                <label for="end_time"><i class="fas fa-calendar-check"></i> To Date</label>
                <input type="datetime-local" id="end_time" name="end_time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="fps"><i class="fas fa-tachometer-alt"></i> Speed (FPS)</label>
            <input type="range" id="fps" name="fps" min="1" max="30" value="10" 
                   style="width: 100%;" oninput="updateFpsDisplay(this.value)">
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                <span class="helper-text">Slow (1)</span>
                <span id="fpsValue" style="font-weight: 600; color: var(--primary);">10 FPS</span>
                <span class="helper-text">Fast (30)</span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-wrapper">
                <input type="checkbox" name="show_timestamp" checked>
                <span><i class="fas fa-clock"></i> Show timestamp on video</span>
            </label>
        </div>
        
        <button type="submit" id="submitBtn">
            <i class="fas fa-film"></i> Create Video
        </button>
    </form>
</div>

<!-- Processing Modal Overlay -->
<div id="processingOverlay" class="processing-overlay" style="display: none;">
    <div class="processing-modal">
        <div class="processing-spinner"></div>
        <h2><i class="fas fa-video"></i> Creating Video...</h2>
        <p id="processingStatus">Please wait. Do not close or navigate away from this page.</p>
        <div class="processing-timer">
            <i class="fas fa-clock"></i> Elapsed Time: <span id="elapsedTime">00:00</span>
        </div>
        <div class="processing-stats">
            <i class="fas fa-images"></i> Processing: <span id="currentImage">0</span> / <span id="totalImages">0</span> images
        </div>
        <div class="processing-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Closing this page will stop the video creation!</span>
        </div>
        <div class="processing-progress">
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
            </div>
            <span id="progressText">Preparing data...</span>
        </div>
    </div>
</div>

<!-- Important Notice -->
<div class="card" style="border-left: 4px solid var(--primary);">
    <div class="card-header">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>Important: Select Project and Camera</h2>
    </div>
    <p style="color: var(--text-muted);">
        <strong>For accurate time-lapse videos,</strong> please select a specific project and camera.<br>
        Without selection, images from multiple cameras will be mixed, resulting in inconsistent video.
    </p>
</div>

<!-- FPS Guide -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-info-circle"></i>
        <h2>Speed Settings Guide</h2>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>FPS</th>
                    <th>Playback Style</th>
                    <th>Best For</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-primary">1-5</span></td>
                    <td>Slow playback, detailed observation</td>
                    <td>Viewing detailed changes</td>
                </tr>
                <tr>
                    <td><span class="badge badge-primary">6-15</span></td>
                    <td>Normal speed</td>
                    <td>Viewing overall growth</td>
                </tr>
                <tr>
                    <td><span class="badge badge-secondary">16-30</span></td>
                    <td>Fast playback</td>
                    <td>Long-term summary</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Tips -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-lightbulb"></i>
        <h2>Tips</h2>
    </div>
    <ul class="feature-list">
        <li>
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Select project and camera for consistent video without mixed camera angles</span>
        </li>
        <li>
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Leave date range empty to use all available images</span>
        </li>
        <li>
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Select a category to focus on specific sections</span>
        </li>
        <li>
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Videos will be saved as downloadable files</span>
        </li>
        <li>
            <i class="fas fa-check" style="color: var(--primary);"></i>
            <span>Timestamp overlay helps track changes over time</span>
        </li>
    </ul>
</div>

<style>
/* Mobile Responsive for Generate Video */
@media (max-width: 640px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    input[type="range"] {
        width: 100%;
    }
    
    .table-container {
        margin: 0 -16px;
        width: calc(100% + 32px);
        border-radius: 0;
    }
    
    table th, table td {
        padding: 10px 8px;
        font-size: 12px;
    }
    
    #generateBtn {
        width: 100%;
        padding: 16px;
        font-size: 16px;
    }
    
    #progressContainer {
        padding: 16px;
    }
    
    #videoResult video {
        width: 100%;
        height: auto;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateFpsDisplay(value) {
    document.getElementById('fpsValue').textContent = value + ' FPS';
}

function loadCameras() {
    const projectSelect = document.getElementById('project_name');
    const cameraSelect = document.getElementById('camera_id');
    const selectedProject = projectSelect.value;
    
    if (selectedProject) {
        fetch(`/api/cameras/${encodeURIComponent(selectedProject)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cameraSelect.innerHTML = '<option value="">-- All Cameras --</option>';
                    data.cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera;
                        option.textContent = camera;
                        cameraSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading cameras:', error));
    }
}

// Global variables
let currentJobId = null;
let timerInterval = null;
let progressPollInterval = null;
let startTime = null;
let totalImages = 0;

document.getElementById('videoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Starting...';
    
    // Show processing overlay
    showProcessingOverlay();
    
    // Start video generation
    const formData = new FormData(this);
    
    fetch('/api/generate-video/start', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentJobId = data.job_id;
            totalImages = data.total_images;
            document.getElementById('totalImages').textContent = totalImages;
            
            // Start polling for progress
            startProgressPolling();
        } else {
            hideProcessingOverlay();
            showError(data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-film"></i> Create Video';
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        showError('An error occurred: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-film"></i> Create Video';
    });
});

function startProgressPolling() {
    progressPollInterval = setInterval(() => {
        if (!currentJobId) return;
        
        fetch(`/api/generate-video/progress/${currentJobId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar with real data
                updateRealProgress(data);
                
                // Check if completed
                if (data.completed) {
                    clearInterval(progressPollInterval);
                    progressPollInterval = null;
                    
                    if (data.success) {
                        // Finalize and get video ID
                        finalizeVideo();
                    } else {
                        hideProcessingOverlay();
                        showError(data.error || 'Error creating video');
                        resetForm();
                    }
                }
            })
            .catch(error => {
                console.error('Progress poll error:', error);
            });
    }, 500); // Poll every 500ms
}

function updateRealProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentImage = document.getElementById('currentImage');
    
    // Update progress bar
    progressBar.style.width = data.percent + '%';
    
    // Update current image count
    currentImage.textContent = data.current;
    
    // Update status text
    switch(data.status) {
        case 'preparing':
            progressText.textContent = 'Preparing data...';
            break;
        case 'processing':
            progressText.textContent = '';
            break;
        case 'encoding':
            progressText.textContent = 'Encoding video...';
            progressBar.style.width = '95%';
            break;
        case 'complete':
            progressText.textContent = 'Complete!';
            progressBar.style.width = '100%';
            break;
        default:
            progressText.textContent = 'Processing...';
    }
}

function finalizeVideo() {
    fetch(`/api/generate-video/complete/${currentJobId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingOverlay();
        
        if (data.success) {
            showSuccess('Video created successfully!', data.video_id, data.snapshot_count);
        } else {
            showError(data.error || 'An error occurred');
            resetForm();
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        showError('An error occurred: ' + error);
        resetForm();
    });
}

function resetForm() {
    const btn = document.getElementById('submitBtn');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-film"></i> Create Video';
    currentJobId = null;
}

function showProcessingOverlay() {
    const overlay = document.getElementById('processingOverlay');
    overlay.style.display = 'flex';
    
    // Reset to initial state
    resetOverlayContent();
    
    // Reset progress
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('elapsedTime').textContent = '00:00';
    document.getElementById('progressText').textContent = 'Preparing data...';
    document.getElementById('currentImage').textContent = '0';
    document.getElementById('totalImages').textContent = '0';
    
    // Start timer
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
    
    // Prevent page leave
    window.onbeforeunload = function(e) {
        e.preventDefault();
        e.returnValue = 'Video creation is not complete. Are you sure you want to leave this page?';
        return e.returnValue;
    };
}

function resetOverlayContent() {
    const modal = document.querySelector('.processing-modal');
    modal.innerHTML = `
        <div class="processing-spinner"></div>
        <h2><i class="fas fa-video"></i> Creating Video...</h2>
        <p id="processingStatus">Please wait. Do not close or navigate away from this page.</p>
        <div class="processing-timer">
            <i class="fas fa-clock"></i> Elapsed Time: <span id="elapsedTime">00:00</span>
        </div>
        <div class="processing-stats">
            <i class="fas fa-images"></i> Processing: <span id="currentImage">0</span> / <span id="totalImages">0</span> images
        </div>
        <div class="processing-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Closing this page will stop the video creation!</span>
        </div>
        <div class="processing-progress">
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
            </div>
            <span id="progressText">Preparing data...</span>
        </div>
    `;
}

function hideProcessingOverlay() {
    // Stop timer
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    if (progressPollInterval) {
        clearInterval(progressPollInterval);
        progressPollInterval = null;
    }
    
    // Remove page leave warning
    window.onbeforeunload = null;
    
    // Hide overlay
    document.getElementById('processingOverlay').style.display = 'none';
}

function showSuccess(message, videoId, snapshotCount) {
    const overlay = document.getElementById('processingOverlay');
    const modal = overlay.querySelector('.processing-modal');
    
    // Remove page leave warning
    window.onbeforeunload = null;
    
    overlay.style.display = 'flex';
    modal.innerHTML = `
        <div style="color: var(--success); font-size: 4rem; margin-bottom: 1rem;">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2 style="color: var(--success);">Video Created Successfully!</h2>
        <p style="margin: 1rem 0;">Processed ${snapshotCount} images successfully.</p>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Downloading video...</p>
        <div class="processing-spinner" style="margin-bottom: 1rem;"></div>
        <a href="/videos" class="btn" style="display: inline-block; margin-top: 1rem;">
            <i class="fas fa-list"></i> Go to Video List
        </a>
    `;
    
    // Trigger download via hidden iframe (doesn't change page)
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = '/video/' + videoId;
    document.body.appendChild(iframe);
    
    // After download triggers, update message
    setTimeout(() => {
        modal.innerHTML = `
            <div style="color: var(--success); font-size: 4rem; margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 style="color: var(--success);">Download Started!</h2>
            <p style="margin: 1rem 0;">Processed ${snapshotCount} images successfully.</p>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">File is downloading. Check your Downloads folder.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="/videos" class="btn" style="display: inline-block;">
                    <i class="fas fa-list"></i> View Video List
                </a>
                <a href="/generate-video" class="btn btn-secondary" style="display: inline-block;">
                    <i class="fas fa-plus"></i> Create New Video
                </a>
            </div>
        `;
    }, 2000);
}

function showError(errorMessage) {
    const overlay = document.getElementById('processingOverlay');
    const modal = overlay.querySelector('.processing-modal');
    
    // Remove page leave warning
    window.onbeforeunload = null;
    
    overlay.style.display = 'flex';
    modal.innerHTML = `
        <div style="color: var(--danger); font-size: 4rem; margin-bottom: 1rem;">
            <i class="fas fa-times-circle"></i>
        </div>
        <h2 style="color: var(--danger);">Error Occurred</h2>
        <p style="margin: 1rem 0; color: var(--dark);">${errorMessage}</p>
        <button onclick="location.reload()" class="btn" style="margin-top: 1rem;">
            <i class="fas fa-redo"></i> Try Again
        </button>
    `;
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const elapsedEl = document.getElementById('elapsedTime');
    if (elapsedEl) {
        elapsedEl.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    }
}

// Handle visibility change - warn user
document.addEventListener('visibilitychange', function() {
    if (document.hidden && document.getElementById('processingOverlay').style.display === 'flex') {
        console.log('Warning: Page hidden during video processing');
    }
});
</script>

<style>
.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--modal-overlay);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.processing-modal {
    background: var(--modal-bg);
    border-radius: 20px;
    padding: 3rem;
    text-align: center;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.processing-spinner {
    width: 80px;
    height: 80px;
    border: 6px solid var(--surface);
    border-top: 6px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.processing-modal h2 {
    color: var(--dark);
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

.processing-modal p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
}

.processing-timer {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 1rem;
}

.processing-timer i {
    margin-right: 0.5rem;
}

.processing-stats {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--primary-light);
    border-radius: 10px;
    display: inline-block;
}

.processing-stats i {
    margin-right: 0.5rem;
    color: var(--primary);
}

.processing-stats span {
    color: var(--primary);
}

.processing-warning {
    background: var(--warning-light);
    border: 1px solid var(--warning);
    color: var(--warning);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    font-weight: 500;
}

.processing-warning i {
    margin-right: 0.5rem;
    color: var(--warning);
}

.processing-progress {
    margin-top: 1rem;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-bar-inner {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 4px;
    width: 20%;
    transition: width 0.1s ease;
}

#progressText {
    font-size: 0.9rem;
    color: var(--text-muted);
}

/* Mobile Responsive for Generate Video Modal */
@media (max-width: 640px) {
    .processing-modal {
        padding: 1.5rem;
        border-radius: 16px;
        width: 95%;
    }
    .processing-spinner {
        width: 60px;
        height: 60px;
    }
    .processing-modal h2 {
        font-size: 1.2rem;
    }
    .processing-timer {
        font-size: 1.5rem;
    }
    .processing-stats {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    .processing-warning {
        font-size: 0.85rem;
        padding: 0.75rem;
    }
}
</style>
{% endblock %}
